<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>암호학 & 패스워드 보안 실습</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h1, h2 { color: #333; text-align: center; }
        h1 { font-size: 2.5em; margin-bottom: 10px; }
        h2 { font-size: 1.5em; margin-top: 0; color: #606770; }
        .container { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1); padding: 20px; margin-top: 20px; width: 100%; max-width: 600px; }
        .card { border: 1px solid #dddfe2; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .card h3 { margin-top: 0; color: #1877f2; border-bottom: 1px solid #dddfe2; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 5px; }
        input[type="file"], input[type="password"], input[type="text"] { width: calc(100% - 20px); padding: 10px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 1em; }
        .button { background-color: #1877f2; color: white; border: none; border-radius: 6px; padding: 12px 20px; font-size: 1.1em; font-weight: 600; cursor: pointer; width: 100%; transition: background-color 0.3s; }
        .button:hover { background-color: #166fe5; }
        .button:disabled { background-color: #9dbdf2; cursor: not-allowed; }
        .spinner { display: inline-block; width: 16px; height: 16px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .flash-messages { list-style: none; padding: 0; margin-bottom: 20px; }
        .flash-messages li { padding: 15px; border-radius: 6px; margin-bottom: 10px; font-weight: 500; }
        .flash-messages .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash-messages .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .flash-messages .crack-result { background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db; font-family: 'Courier New', Courier, monospace; }
        .flash-messages .crack-result pre { white-space: pre-wrap; word-wrap: break-word; }
        .description { font-size: 0.9em; color: #606770; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>🛡️ 암호학 & 패스워드 보안 실습</h1>
    <h2>CLI 프로젝트의 웹 버전 (Dockerized)</h2>

    <div class="container">
        <!-- Flash 메시지 및 직접 전달된 결과 표시 영역 -->
        {% set crack_result = crack_result or get_flashed_messages(category_filter=['crack_result']) | first %}
        {% if crack_result %}
            <div class="flash-messages">
                <li class="crack-result"><h3>테스트 결과</h3><pre>{{ crack_result }}</pre></li>
            </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <ul class="flash-messages">
                {% for category, message in messages %}
                    {% if category != 'crack_result' %}
                        {% if '✅' in message %}
                             <li class="success">{{ message }}</li>
                        {% else %}
                            <li class="error">{{ message }}</li>
                        {% endif %}
                    {% endif %}
                {% endfor %}
                </ul>
            {% endif %}
        {% endwith %}

        <!-- Part 1: 안전한 파일 암호화/복호화 -->
        <div class="card">
            <h3>Part 1: (방어) 안전한 파일 금고</h3>
            <p class="description">AES-GCM 암호화와 PBKDF2 키 유도 함수를 사용하여 파일을 안전하게 잠그거나 엽니다. 모든 파일은 고유한 솔트(Salt)로 보호됩니다.</p>
            
            <!-- 암호화 폼 -->
            <form action="/encrypt" method="post" enctype="multipart/form-data">
                <h4>암호화</h4>
                <div class="form-group">
                    <label for="enc-file">파일 선택</label>
                    <input type="file" id="enc-file" name="file" required>
                </div>
                <div class="form-group">
                    <label for="enc-password">비밀번호</label>
                    <input type="password" id="enc-password" name="password" required>
                </div>
                <button type="submit" class="button">파일 암호화</button>
            </form>
            <hr style="margin: 20px 0; border: 1px solid #f0f2f5;">
            <!-- 복호화 폼 -->
            <form action="/decrypt" method="post" enctype="multipart/form-data">
                <h4>복호화</h4>
                <div class="form-group">
                    <label for="dec-file">암호화된 파일 선택 (e.g., myfile_encrypted.txt)</label>
                    <input type="file" id="dec-file" name="file" required>
                </div>
                <div class="form-group">
                    <label for="dec-password">비밀번호</label>
                    <input type="password" id="dec-password" name="password" required>
                </div>
                <button type="submit" class="button">파일 복호화</button>
            </form>
        </div>

        <!-- Part 2: 보안 테스트 -->
        <div class="card">
            <h3>Part 2: (증명) 보안 테스트</h3>
            <p class="description">Part 1의 안전한 방식으로 암호화된 파일을 대상으로 사전 공격(Dictionary Attack)을 시도하여, 왜 '솔트(Salt)'가 중요한지 직접 증명합니다.</p>
            <form action="/test_security" method="post">
                <button type="submit" class="button" style="background-color: #2ecc71;">안전한 암호화 크랙 시도</button>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 기능 1: 폼 제출 시 버튼 비활성화 및 스피너 표시 ---
            const forms = document.querySelectorAll('form');
            forms.forEach(form => {
                form.addEventListener('submit', function() {
                    const button = this.querySelector('button[type="submit"]');
                    if (button) {
                        button.disabled = true;
                        button.innerHTML = '<span class="spinner"></span>처리 중...';
                    }
                });
            });

            // --- 기능 2: 페이지 로드 시 자동 다운로드 처리 ---
            const urlParams = new URLSearchParams(window.location.search);
            const fileToDownload = urlParams.get('download_file');

            if (fileToDownload) {
                const downloadUrl = `/download/${encodeURIComponent(fileToDownload)}`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
</body>
</html>